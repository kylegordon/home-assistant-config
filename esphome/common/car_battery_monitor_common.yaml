---
# Inspired by https://www.reddit.com/r/homeautomation/comments/qiywpf/monitoring_a_car_battery_from_charged_over_first/
packages:
  common: !include common.yaml

esp8266:
  board: d1_mini

esphome:
  name: ${device_name}
  comment: ${device_description}
  friendly_name: ${friendly_name}

  on_boot:
    priority: -200
    then:
      - wait_until:
          api.connected:
      - delay: 2s
      - logger.log: "Checking if deep sleep allowed"
      - lambda: |-
          if(id(esphome_ota_enable).state) {
            ESP_LOGD("main", "Home-Assistant in OTA mode");
            id(deep_sleep_1).prevent_deep_sleep();
          } else {
            ESP_LOGD("main", "Home-Assistant not in OTA mode");
          }
      - logger.log: "Sleep checked"

# Enable logging
logger:

# Disabled to save resources during deep sleep
# web_server:

deep_sleep:
  id: deep_sleep_1
  run_duration: 20s
  sleep_duration: 10min

binary_sensor:
  - platform: homeassistant
    name: "Home-Assistant OTA Enable"
    entity_id: input_boolean.esphome_ota_enable
    id: esphome_ota_enable
    internal: true
    on_state:
      then:
        - if:
            condition:
              binary_sensor.is_on: esphome_ota_enable
            then:
              - logger.log: "Preventing deep sleep, Home Assistant activated"
              - deep_sleep.prevent: deep_sleep_1
            else:
              - logger.log: "Allowing deep sleep, Home Assistant activated"
              - deep_sleep.enter: deep_sleep_1

  - platform: template
    name: "${friendly_name} Low Battery"
    id: low_battery_alert
    device_class: problem
    lambda: |-
      return id(battery_voltage).state < 12.0;

sensor:
  - platform: adc
    pin: A0
    name: "${friendly_name} Voltage"
    id: battery_voltage
    device_class: voltage
    unit_of_measurement: "V"
    accuracy_decimals: 2
    state_class: measurement
    update_interval: 15s
    filters:
      # This might need to be adjusted for your device
      - multiply: ${multiplier}

  - platform: template
    name: "${friendly_name} Battery Percentage"
    device_class: battery
    unit_of_measurement: "%"
    accuracy_decimals: 0
    state_class: measurement
    lambda: |-
      // Car battery voltage to percentage mapping
      // 12.6V+ = 100%, 12.4V = 75%, 12.2V = 50%, 12.0V = 25%, <11.8V = 0%
      float voltage = id(battery_voltage).state;
      if (voltage >= 12.6) return 100;
      if (voltage >= 12.4) return 75 + ((voltage - 12.4) / 0.2 * 25);
      if (voltage >= 12.2) return 50 + ((voltage - 12.2) / 0.2 * 25);
      if (voltage >= 12.0) return 25 + ((voltage - 12.0) / 0.2 * 25);
      if (voltage >= 11.8) return ((voltage - 11.8) / 0.2 * 25);
      return 0;
    update_interval: 15s

output:
  # Register the blue LED as a dimmable output ....
  - platform: esp8266_pwm
    id: blue_led
    pin: D4
    inverted: true

light:
  # ... and then make a light out of it.
  - platform: monochromatic
    id: blue_led_light
    name: "${friendly_name} Status LED"
    output: blue_led

# Consolidated LED status indicator - checks WiFi, API, and OTA status
script:
  - id: blink_led
    mode: restart
    parameters:
      num_blinks: int
    then:
      - repeat:
          count: !lambda 'return num_blinks;'
          then:
            - light.turn_on:
                id: blue_led_light
                brightness: 100%
                transition_length: 0s
            - delay: 250ms
            - light.turn_off:
                id: blue_led_light
                transition_length: 0ms
            - delay: 250ms

interval:
  - interval: 5000ms
    id: status_led
    then:
      - if:
          condition:
            binary_sensor.is_on: esphome_ota_enable
          then:
            # OTA enabled: 3 blinks
            - script.execute:
                id: blink_led
                num_blinks: 3
          else:
            - if:
                condition:
                  not:
                    api.connected:
                then:
                  # No API: 2 blinks
                  - script.execute:
                      id: blink_led
                      num_blinks: 2
                else:
                  - if:
                      condition:
                        not:
                          wifi.connected:
                      then:
                        # No WiFi: 1 blink
                        - script.execute:
                            id: blink_led
                            num_blinks: 1
