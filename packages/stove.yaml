---
sensor:
  - platform: template
    sensors:
      stove_sensor:
        friendly_name: Hwam Stove
        icon_template: >
          {%- set phase = states.sensor.hwam_smart_stove_phase.state %}
          {%- set refuel = states.binary_sensor.hwam_smart_stove_refill_needed.state %}
          {%- if phase == 'Burn' %}
            mdi:fire
          {%- elif phase == 'Standby' %}
            mdi:power
          {%- elif phase == 'Ignition' %}
            mdi:circle-outline
          {%- elif refuel == 'on' %}
            mdi:autorenew
          {%- else -%}
            mdi:blur
          {%- endif %}
        value_template: >
          {%- set phase = states.sensor.hwam_smart_stove_phase.state %}
          {%- set temp = states.sensor.hwam_smart_stove_temperature.state %}
          {%- set timer = states.sensor.hwam_smart_stove_time_to_new_firewood.state %}
          {%- set refill_timer = (timer | int(0) // 3600) ~ ':' ~ ((timer | int(0) % 3600) // 60) | string().zfill(2) %}
          {%- set refuel = states.binary_sensor.hwam_smart_stove_refill_needed.state %}
          {%- if phase == 'Burn' %}
            {{ temp }} Â°C
          {%- elif phase == 'Standby' %}
            Standby
          {%- elif phase == 'Ignition' %}
            Start
          {%- elif refuel == 'on' %}
            Refuel now!
          {%- else -%}
            Refuel in
            {{ refill_timer }}
          {%- endif %}

automation:
  - alias: More wood
    id: time_to_new_fire_wood
    trigger:
      - platform: state
        entity_id: binary_sensor.hwam_smart_stove_refill_needed
        from: "off"
        to: "on"
    condition:
      - condition: not
        conditions:
          - condition: state
            entity_id: sensor.time_of_day
            state: "Night"
    action:
      - service: notify.alexa_media
        data_template:
          target:
            - media_player.living_room
          data:
            type: announce
            # method: all
          message: "The stove requires more wood."
      - service: notify.mobile_app_nothing_phone_2
        data:
          title: "More wood needed!"
          message: >
            The stove is running low on wood. Refuel now.
      - service: script.tweet_engine
        data_template:
          tweet: >
            {{ [
            "The stove is running low on fuel!",
            "Time to get wood..."
            ] | random + " https://amzn.to/3HO2IDZ" }}
