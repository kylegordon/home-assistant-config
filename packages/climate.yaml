---
# Inspired by https://github.com/downthedeck/hassio-config/blob/master/packages/klimaat.yaml
# Not all modes are supported, as above uses Toon integration
# https://www.home-assistant.io/integrations/generic_thermostat/
# Generic thermostat currently only supports 'heat', 'cool' and 'off'

binary_sensor:
  - platform: workday
    name: Workday
    country: GB
  - platform: workday
    name: Workday tomorrow
    country: GB
    days_offset: 1
  - platform: group
    # Openings that should prevent the heating from coming on
    name: Climate Openings
    device_class: opening
    entities:
      - binary_sensor.back_door
      - binary_sensor.front_door
      - binary_sensor.patio_door
      - binary_sensor.ensuite_window
      - binary_sensor.master_bedroom_window
      - binary_sensor.guest_bedroom_window
      - binary_sensor.study_window
      - binary_sensor.craft_room_window
      - binary_sensor.bathroom_window
      - binary_sensor.dining_table_window
      - binary_sensor.kitchen_window
      - binary_sensor.utility_room_window

group:
  call_for_heat:
    # Add zones here. Essentially a glorified OR condition
    name: Call For Heat - Group
    entities:
      - input_boolean.call_for_rad_heat
      - input_boolean.call_for_guest_heat

input_boolean:
  # Inputs from external thermostats, such as household generic or a single room
  call_for_rad_heat:
    name: Call for heat - General
    icon: mdi:radiator
  call_for_guest_heat:
    name: Call for heat - Guest Room
    icon: mdi:radiator

automation:
  - alias: "Call for heat - demand"
    description: >-
      Turn on boiler relay if there's a call for heat
      and all the openings are shut
    trigger:
      platform: time_pattern
      seconds: 30
    condition:
      - condition: state
        entity_id: group.call_for_heat
        state: 'on'
      - condition: state
        entity_id: binary_sensor.climate_openings
        state: 'off'
        for:
          minutes: 5
    action:
      - service: homeassistant.turn_on
        entity_id: switch.boiler_valve_controls_relay_2

  - alias: "Call for heat - no demand"
    description: Turn off boiler relay if demand for heat ceases
    trigger:
      platform: time_pattern
      seconds: 30
    condition:
      condition: or
      conditions:
        - condition: state
          entity_id: group.call_for_heat
          state: 'off'
        - condition: state
          entity_id: binary_sensor.climate_openings
          state: 'on'
          for:
            minutes: 5
    action:
      - service: homeassistant.turn_off
        entity_id: switch.boiler_valve_controls_relay_2

  - alias: "Climate - Away"
    trigger:
      - platform: state
        entity_id: group.people
        to: "not_home"
        for:
          minutes: 15
    action:
      - service: climate.set_preset_mode
        data:
          entity_id: all
          preset_mode: "away"
      - service: logbook.log
        data_template:
          name: EVENT
          message: >
            Setting heating and hot water thermostat to away mode

  - alias: "Climate - Comfort"
    trigger:
      - platform: time
        at: "19:00:00"
    condition:
      - condition: state
        entity_id: group.people
        state: "home"
    action:
      - service: climate.set_preset_mode
        data:
          entity_id: climate.house
          preset_mode: "none"
      - service: logbook.log
        data_template:
          name: EVENT
          message: >
            Setting heating and hot water thermostat to normal mode

  - alias: "Climate - home"
    trigger:
      - platform: state
        entity_id: group.people
        to: "home"
    action:
      - service: climate.set_preset_mode
        data:
          entity_id: all
          preset_mode: "none"
      - service: logbook.log
        data_template:
          name: EVENT
          message: >
            Setting heating and hot water thermostat to normal mode


  - alias: "Climate - Sleep (tomorrow workday)"
    trigger:
      - platform: time
        at: "21:00:00"
    condition:
      - condition: state
        entity_id: binary_sensor.workday_tomorrow
        state: "on"
      - condition: state
        entity_id: binary_sensor.home_occupied
        state: "on"
    action:
      - service: climate.set_temperature
        data:
          entity_id: climate.house
          temperature: 17
      - service: logbook.log
        data_template:
          name: EVENT
          message: >
            Setting heating low for sleeping

  - alias: "Climate - Sleep (tomorrow not workday)"
    trigger:
      - platform: time
        at: "23:00:00"
    condition:
      - condition: state
        entity_id: binary_sensor.workday_tomorrow
        state: "off"
      - condition: state
        entity_id: binary_sensor.home_occupied
        state: "on"
    action:
      - service: climate.set_temperature
        data:
          entity_id: climate.house
          temperature: 17
      - service: logbook.log
        data_template:
          name: EVENT
          message: >
            Setting heating low for sleeping

  - alias: "Climate - Weekday Morning"
    trigger:
      - platform: time
        at: "06:30:00"
    condition:
      - condition: state
        entity_id: binary_sensor.workday
        state: "on"
      - condition: state
        entity_id: binary_sensor.home_occupied
        state: "on"
    action:
      - service: climate.set_preset_mode
        data:
          entity_id: all
          preset_mode: "none"
      - service: climate.set_temperature
        data:
          entity_id: climate.house
          temperature: 20
      - service: logbook.log
        data_template:
          name: EVENT
          message: >
            Warming the house up for a weekday morning.

  - alias: "Climate - Lazy Morning"
    trigger:
      - platform: time
        at: "07:30:00"
    condition:
      - condition: state
        entity_id: binary_sensor.workday
        state: "off"
      - condition: state
        entity_id: binary_sensor.home_occupied
        state: "on"
    action:
      - service: climate.set_preset_mode
        data:
          entity_id: all
          preset_mode: "none"
      - service: climate.set_temperature
        data:
          entity_id: climate.house
          temperature: 20
      - service: logbook.log
        data_template:
          name: EVENT
          message: >
            Warming the house up for a lazy morning.
