switch:
  - platform: template
    switches:
      call_for_rad_heat:
        friendly_name: "Call for Radiator Heat"
        value_template: "{{ is_state('sensor.call_for_rad_heat', 'on') }}"
        turn_on:
          service: switch.turn_on
          target:
            entity_id: switch.boiler_valve_controls_relay_2
        turn_off:
          service: switch.turn_off
          target:
            entity_id: switch.boiler_valve_controls_relay_2

sensor:
  - platform: template
    sensors:
      call_for_rad_heat:
        friendly_name: "Call for radiator heat"
        value_template: "{{ state_attr('switch.call_for_rad_heat', 'on') or state_attr('switch.boiler_valve_controls_relay_2', 'on') }}"
      guest_bedroom_trv_temperature:
        friendly_name: "Guest Bedroom TRV Current Temperature"
        value_template: "{{ state_attr('climate.guest_bedroom_trv', 'current_temperature') }}"
        unit_of_measurement: '°C'
        device_class: temperature
      guest_room_trv_offset:
        friendly_name: Guest Room TRV Offset
        value_template: '{{ ((states.sensor.guest_room_temperature.state | float) - (states.sensor.guest_bedroom_trv_temperature.state | float)) }}'
        unit_of_measurement: '°C'
        device_class: temperature
      guest_room_fake_temperature:
        friendly_name: Guest Room Fake TRV Temperature
        value_template: '{{ (states.sensor.guest_bedroom_trv_temperature.state | float) + (states.sensor.guest_room_trv_offset.state | float)   }}'
        unit_of_measurement: '°C'
        device_class: temperature
      guest_room_target_temperature:
        friendly_name: Guest Room Target
        value_template: "{{ ( state_attr('climate.guest_room', 'temperature') | float) - (states.sensor.guest_room_trv_offset.state | float) }}"

climate:
  - platform: generic_thermostat
    name: Guest Room
    heater: switch.call_for_rad_heat
    target_sensor: sensor.guest_room_fake_temperature
    min_temp: 10
    max_temp: 25
    away_temp: 15

automation:
  trigger:
    platform: state
    entity_id: sensor.guest_room_target_temperature
    for:
      seconds: 10
  action:
    - service: climate.set_temperature
      data:
        entity_id: climate.guest_bedroom_trv
        temperature: "{{ trigger.to_state.state | float }}"

