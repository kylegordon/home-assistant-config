---
homeassistant:
  ## This doesn't seem to work. It needs to be surfaced in configuration.yaml
  customize:
    input_boolean.goodnight:
      hidden: false

input_boolean:
  goodnight_process:
    name: Goodnight process
    icon: mdi:sleep
    initial: false

automation:
  - alias: Goodnight process
    id: goodnight_process
    trigger:
      - platform: state
        entity_id: input_boolean.goodnight_process
        to: 'on'
    action:
      - service: logbook.log
        data_template:
          name: EVENT
          message: "Triggering goodnight mode"
          entity_id: input_boolean.goodnight_process
          domain: input_boolean
      - service: cover.close_cover
        entity_id:
          - cover.patio_blinds
          - cover.front_hall_blinds
      - service: homeassistant.turn_off
        entity_id:
          - light.outside_lights
          - light.twig_lights
          - light.under_bed_lights
      - service: light.turn_off
        target:
          area_id:
            - "{{ area_id('Living Room') }}"
            - "{{ area_id('Master Bedroom') }}"
            - "{{ area_id('Kitchen') }}"
            - "{{ area_id('Hallway') }}"
            - "{{ area_id('Front Hall') }}"
            - "{{ area_id('Dining Nook') }}"
            - "{{ area_id('Boot Room') }}"
            - "{{ area_id('Study') }}"
            - "{{ area_id('Craft Room') }}"
            - "{{ area_id('Ensuite') }}"
            - "{{ area_id('Outside') }}"
      - condition: or
        # If guests are staying, don't turn off their bedroom lights
        conditions:
          - condition: state
            entity_id: binary_sensor.guest_mode
            state: 'off'
      - service: light.turn_off
        target:
          area_id:
            - "{{ area_id('Guest Bedroom') }}"

  - alias: Goodnight process reset
    id: goodnight_process_reset
    trigger:
      - platform: time
        at: '04:00:00'
    action:
      - service: logbook.log
        data_template:
          name: EVENT
          message: "Resetting goodnight mode"
          entity_id: input_boolean.goodnight_process
          domain: input_boolean
      - service: input_boolean.turn_off
        entity_id: input_boolean.goodnight_process
