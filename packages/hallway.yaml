---
input_number:
  hallway_light_level_trigger:
    name: Hallway light level trigger
    icon: mdi:sun-angle-outline
    unit_of_measurement: lx
    min: 0
    max: 10000
    step: 1

automation:
  - alias: Hallway light toggle
    id: hallway_light_toggle
    # Can be improved, examples at https://github.com/TheFes/HA-configuration/blob/main/include/automation/01_first_floor/floris/shelly_floris.yaml
    trigger:
      - platform: event
        event_type: esphome.tx_ultimate_easy
        event_data:
          device_name: hall_single_switch
          action: click
      - platform: event
        event_type: esphome.button_pressed
        event_data:
          device_name: hall_dual_switch_touchpad_2
          click_type: single
    action:
      # Turn on the rainbow effect for 5 seconds
      # to show the button press was registered
      - service: light.turn_on
        target:
          entity_id:
            - light.hall_single_switch_light_eu
        data:
          effect: "Rainbow - Fast"
      - service: switch.turn_on
        target:
          entity_id:
            - switch.hall_single_switch_relay
            - switch.hall_dual_switch_relay_1
      - service: light.toggle
        target:
          entity_id:
            - light.hall
      - service: logbook.log
        data:
          name: EVENT
          message: "Toggling hallway lights"
      - delay: "00:00:05"
      - service: light.turn_off
        target:
          entity_id:
            - light.hall_single_switch_light_eu
        data:
          transition: 1

  - alias: Hallway light motion
    id: hallway_light_motion
    initial_state: true
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.hallway_rooms_occupancy
          - binary_sensor.hallway_bathroom_occupancy
        to: 'on'
        from: 'off'
    condition:
      - condition: numeric_state
        entity_id: sensor.average_external_light_level
        below: input_number.hallway_light_level_trigger
      - condition: state
        entity_id: binary_sensor.home_occupied
        state: "on"
    action:
      - service: logbook.log
        data:
          name: EVENT
          message: "Turning hall lights on"
          entity_id: light.hall
      ### Use choose to set brightness based on time of day
      ### Could be improved with adaptive lighting?
      ### Hallway bedrooms and bathroom lights need listed individually as the
      ### Z2M group does not behave correctly. Initial start values are ignored.
      - choose:
          - conditions:
              - condition: state
                entity_id: sensor.time_of_day
                state: "Night"
            sequence:
              - service: light.turn_on
                target:
                  entity_id:
                    - light.hallway_bedrooms
                    - light.hallway_bathroom
                data:
                  brightness: 64
                  transition: 30
          - conditions:
              - condition: state
                entity_id: sensor.time_of_day
                state: "Morning"
            sequence:
              - service: light.turn_on
                target:
                  entity_id:
                    - light.hallway_bedrooms
                    - light.hallway_bathroom
                data:
                  brightness: 128
                  transition: 30
        default:
          - service: light.turn_on
            target:
              entity_id:
                - light.hallway_bedrooms
                - light.hallway_bathroom
            data:
              brightness: 255
              transition: 30

  - alias: Hallway motion - 2 minute night timeout
    id: hallway_motion_2_minute_night_timeout
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.hallway_rooms_occupancy
          - binary_sensor.hallway_bathroom_occupancy
        to: 'off'
        for:
          minutes: 2
    condition:
      - condition: state
        entity_id: sensor.time_of_day
        state: "Night"
    action:
      - service: logbook.log
        data:
          name: EVENT
          message: "Turning hall lights off"
          entity_id: light.hall
      - service: light.turn_off
        target:
          entity_id:
            - light.hall
        data:
          transition: 120

  - alias: Hallway motion - 10 minute timeout
    id: hallway_motion_10_minute_timeout
    trigger:
      - platform: state
        entity_id:
          - binary_sensor.hallway_rooms_occupancy
          - binary_sensor.hallway_bathroom_occupancy
        to: 'off'
        for:
          minutes: 10
    action:
      - service: logbook.log
        data:
          name: EVENT
          message: "Turning hall lights off"
          entity_id: light.hall
      - service: light.turn_off
        target:
          entity_id:
            - light.hall
        data:
          transition: 600

  - alias: Hallway - sunlight timeout
    id: hallway_sunlight_timeout
    trigger:
      - platform: numeric_state
        entity_id: sensor.average_external_light_level
        above: input_number.hallway_light_level_trigger
        for:
          minutes: 10
    action:
      - service: logbook.log
        data:
          name: EVENT
          message: "Turning hallway lights off"
          entity_id: light.hall
          domain: light
      - service: light.turn_off
        target:
          entity_id:
            - light.hall
        data:
          transition: 600
