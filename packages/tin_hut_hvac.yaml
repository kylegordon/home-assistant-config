---
homeassistant:
  customize:
    climate.tin_hut_thermostat_overlay:
      room: "Tin Hut"
      friendly_name: "Tin Hut Thermostat Overlay"

climate:
  - platform: template
    name: "Tin Hut Thermostat Overlay"
    unique_id: tin_hut_thermostat_overlay
    min_temp: 10
    max_temp: 25
    hvac_modes:
      - "off"
      - "heat"
    current_temperature_template: >
      {% set temp = states('sensor.tin_hut_sensor_temperature') %}
      {{ temp | float(0) if temp not in ['unavailable', 'unknown', 'none'] else none }}
    target_temperature_template: >
      {% set temp = state_attr('climate.tin_hut_hvac', 'temperature') %}
      {{ temp | float(16) if temp not in [none, 'unavailable', 'unknown'] else 16 }}
    set_hvac_mode:
      service: climate.set_hvac_mode
      target:
        entity_id: climate.tin_hut_hvac
      data:
        hvac_mode: "{{ hvac_mode }}"
    set_temperature:
      service: climate.set_temperature
      target:
        entity_id: climate.tin_hut_hvac
      data:
        temperature: "{{ temperature }}"

automation:
  - alias: "Tin Hut Thermostat Overlay Control"
    id: tin_hut_thermostat_overlay_control
    mode: restart
    trigger:
      - platform: numeric_state
        entity_id: sensor.tin_hut_sensor_temperature
        below: 10
        for: "00:01:00"
      - platform: numeric_state
        entity_id: sensor.tin_hut_sensor_temperature
        above: 12
        for: "00:01:00"
    action:
      - choose:
          - conditions: "{{ trigger.to_state.state | float < 10 }}"
            sequence:
              - service: climate.set_hvac_mode
                target:
                  entity_id: climate.tin_hut_hvac
                data:
                  hvac_mode: "heat"

              # 16C is a valid setpoint the hardware will accept, used as a "heat max cap"
              - service: climate.set_temperature
                target:
                  entity_id: climate.tin_hut_hvac
                data:
                  temperature: 16

          - conditions: "{{ trigger.to_state.state | float > 12 }}"
            sequence:
              - service: climate.set_hvac_mode
                target:
                  entity_id: climate.tin_hut_hvac
                data:
                  hvac_mode: "off"

              # Set back to 16 so it never idles lower than its own minimum capability
              - service: climate.set_temperature
                target:
                  entity_id: climate.tin_hut_hvac
                data:
                  temperature: 16
