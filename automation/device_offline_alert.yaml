alias: Alert when a critical device goes offline
trigger:
  - platform: state
    entity_id:
      - binary_sensor.hallway_sensor_status
      - sensor.kitchen_temperature
      - binary_sensor.utility_room_sensor_status
      - binary_sensor.study_sensor_status
      - sensor.garage_temperature
      - switch.guest_bedroom_lightswitch_relay
      - switch.master_bedroom_lightswitch_relay
      - switch.study_lightswitch_relay
      - switch.craft_room_lightswitch_relay
      - light.driveway_floodlights
      - light.front_door_floodlights
      - light.garage_lights
      - light.study_light
      - light.guest_bedroom
      - light.master_bedroom
      - light.craft_room
      - light.hall_bedrooms
      - light.hall_entrance
    to: 'unavailable'
    for:
      minutes: 2
condition:
  condition: and
  conditions:
    - condition: template
      value_template: >
        {% if states.automation.alert_when_a_critical_device_goes_offline.last_triggered is not none %}
          {% if as_timestamp(now()) | int   -  as_timestamp(states.automation.alert_when_a_critical_device_goes_offline.attributes.last_triggered) | int > 3600 %} true {% else %} false
          {% endif %}
        {% else %}
        false
        {% endif %}
action:
  - service: notify.email_kyle
    data_template:
      message: '{{trigger.to_state.attributes.friendly_name}} has gone offline. Please check the status of this device as some features may stop functioning.'
      title: Device Alert
